<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Accessible guitar tuner for blind and visually impaired users. Provides audio pitch detection with screen reader support.">
<title>Accessible Guitar Tuner</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
<style>
/* Custom styles to complement pico.css */
:root {
    --pico-font-size: 100%;
    --pico-line-height: 1.5;
}

body {
    max-width: 900px;
    margin: 0 auto;
    padding: 1rem;
}

/* Enhanced header styling */
h1 {
    font-size: 3rem;
    min-height: 1.2em;
    margin: 1.5rem 0;
    text-align: center;
    color: var(--pico-primary);
}

/* Tuner display card */
.tuner-display {
    background: var(--pico-card-background-color, #fff);
    border: 2px solid var(--pico-primary, #0284c7);
    border-radius: var(--pico-border-radius, 0.5rem);
    padding: 2rem;
    margin: 1.5rem 0;
    text-align: center;
    box-shadow: var(--pico-box-shadow, 0 4px 6px rgba(0, 0, 0, 0.1));
}

/* Frequency display enhancement */
.frequency-display {
    font-size: 1.75rem;
    font-weight: bold;
    color: var(--pico-contrast, #1a1a1a);
}

#note-name {
    font-size: 4rem;
    font-weight: bold;
    color: var(--pico-primary, #0284c7);
    margin: 1rem 0;
}

#frequency {
    color: var(--pico-muted, #6b7280);
    font-size: 2rem;
}

#confidence {
    font-size: 1.1rem;
    color: var(--pico-muted, #6b7280);
    font-weight: normal;
}

/* Button styling using pico classes */
.button {
    font-size: 1.2rem;
    padding: 1rem 2rem;
    margin: 0.5rem;
    border-radius: var(--pico-border-radius, 0.5rem);
    transition: all var(--pico-transition, 0.2s ease);
}

.button:hover {
    transform: translateY(-2px);
    box-shadow: var(--pico-box-shadow, 0 4px 12px rgba(0, 0, 0, 0.15));
}

.button:active {
    transform: translateY(0);
}

/* Status messages */
.status-message {
    margin: 1rem 0;
    padding: 1rem;
    border-radius: var(--pico-border-radius, 0.5rem);
    font-weight: 500;
    text-align: center;
}

.status-listening {
    background: var(--pico-primary-background, #d4edda);
    border: 1px solid var(--pico-primary, #0284c7);
    color: var(--pico-primary-inverse, #fff);
}

.status-error {
    background: var(--pico-error-background, #f8d7da);
    border: 1px solid var(--pico-error, #dc3545);
    color: var(--pico-error-inverse, #fff);
}

/* Instructions section */
.instructions {
    background: var(--pico-background-color, #f8f9fa);
    padding: 1.5rem;
    border-radius: var(--pico-border-radius, 0.5rem);
    margin: 1.5rem 0;
    border-left: 4px solid var(--pico-primary, #0284c7);
}

.instructions h2 {
    margin-top: 0;
    color: var(--pico-primary, #0284c7);
}

.instructions ol {
    padding-left: 1.5rem;
}

.instructions li {
    margin-bottom: 0.5rem;
    line-height: 1.6;
}

/* Navigation links */
nav {
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid var(--pico-muted-border, #e5e7eb);
    text-align: center;
}

nav a {
    color: var(--pico-primary, #0284c7);
    text-decoration: none;
    margin: 0 0.5rem;
}

nav a:hover {
    text-decoration: underline;
}

/* Responsive design */
@media (max-width: 768px) {
    h1 {
        font-size: 2rem;
    }
    
    #note-name {
        font-size: 2.5rem;
    }
    
    #frequency {
        font-size: 1.5rem;
    }
    
    .button {
        font-size: 1rem;
        padding: 0.875rem 1.5rem;
        width: 100%;
        max-width: 300px;
    }
    
    .tuner-display {
        padding: 1.5rem;
    }
}

/* Accessibility improvements */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
}

/* Focus visible for keyboard navigation */
:focus-visible {
    outline: 3px solid var(--pico-primary, #0284c7);
    outline-offset: 2px;
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
    }
}

/* High contrast mode support */
@media (prefers-contrast: high) {
    .tuner-display {
        border-width: 3px;
    }
    
    .button {
        border-width: 2px;
    }
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    :root {
        --pico-primary: #38bdf8;
        --pico-primary-background: #0c4a6e;
        --pico-background-color: #1f2937;
        --pico-card-background-color: #111827;
        --pico-contrast: #f9fafb;
        --pico-muted: #9ca3af;
    }
}
</style>
<script>
// Define the set of test frequencies that we'll use to analyze microphone data.
var C2 = 65.41; // C2 note, in Hz.
var notes = [ "C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B" ];
var test_frequencies = [];
for (var i = 0; i < 30; i++)
{
	var note_frequency = C2 * Math.pow(2, i / 12);
	var note_name = notes[i % 12];
	var note = { "frequency": note_frequency, "name": note_name };
	var just_above = { "frequency": note_frequency * Math.pow(2, 1 / 48), "name": note_name + " (a bit sharp)" };
	var just_below = { "frequency": note_frequency * Math.pow(2, -1 / 48), "name": note_name + " (a bit flat)" };
	test_frequencies = test_frequencies.concat([ just_below, note, just_above ]);
}

window.addEventListener("load", initialize);

var correlation_worker = new Worker("correlation_worker.js");
correlation_worker.addEventListener("message", interpret_correlation_result);

function initialize()
{
	update_status("Initializing guitar tuner...");
	
	var get_user_media = navigator.getUserMedia;
	get_user_media = get_user_media || navigator.webkitGetUserMedia;
	get_user_media = get_user_media || navigator.mozGetUserMedia;
	
	get_user_media.call(navigator, { "audio": true }, use_stream, function(error) {
		console.error("Microphone access denied:", error);
		update_status("Error: Microphone access denied. Please allow microphone access to use the tuner.", "error");
		document.getElementById("note-name").textContent = "No audio input";
	});

	document.getElementById("play-note").addEventListener("click", toggle_playing_note);
	document.getElementById("toggle-tts").addEventListener("click", toggle_text_to_speech);
	
	// Load voices for text-to-speech
	if (speech_synthesis) {
		speech_synthesis.getVoices();
		speech_synthesis.onvoiceschanged = function() {
			speech_synthesis.getVoices();
		};
	}
	
	// Announce that tuner is ready
	setTimeout(function() {
		announce_to_screen_reader("Guitar tuner ready. Play a note to begin tuning.", "polite");
	}, 1000);
	
	// Check vibration API support
	if ("vibrate" in navigator) {
		console.log("Vibration API supported");
	} else {
		console.log("Vibration API not supported");
	}
	
	// Set git tag dynamically
	fetch('https://api.github.com/repos/barakplasma/Accessible-guitar-tuner/git/refs/heads/master')
		.then(function(response) {
			return response.json();
		})
		.then(function(data) {
			var shortSha = data.object.sha.substring(0, 7);
			document.getElementById('git-tag').textContent = shortSha;
			document.getElementById('git-tag').title = 'Full SHA: ' + data.object.sha;
		})
		.catch(function(error) {
			console.log('Could not fetch git tag:', error);
		});
}

function update_status(message, type) {
	var status_element = document.getElementById("status-message");
	status_element.textContent = message;
	status_element.className = "status-message";
	if (type === "error") {
		status_element.classList.add("status-error");
	} else {
		status_element.classList.add("status-listening");
	}
	status_element.style.display = "block";
	
	// Announce to screen reader
	announce_to_screen_reader(message, "polite");
}

function use_stream(stream)
{
	update_status("Listening for notes...");
	
	var audio_context = new AudioContext();
	var microphone = audio_context.createMediaStreamSource(stream);
	window.source = microphone; // Workaround for https://bugzilla.mozilla.org/show_bug.cgi?id=934512
	var script_processor = audio_context.createScriptProcessor(1024, 1, 1);

	script_processor.connect(audio_context.destination);
	microphone.connect(script_processor);

	var buffer = [];
	var sample_length_milliseconds = 100;
	var recording = true;

	// Need to leak this function into the global namespace so it doesn't get
	// prematurely garbage-collected.
	// http://lists.w3.org/Archives/Public/public-audio/2013JanMar/0304.html
	window.capture_audio = function(event)
	{
		// Pause detection while speech synthesis is speaking
		if (is_speaking) {
			if (!detection_paused_for_speech) {
				detection_paused_for_speech = true;
				update_status("Pausing detection for voice announcement...");
			}
			return;
		}
		
		// Resume detection when speech finishes
		if (detection_paused_for_speech) {
			detection_paused_for_speech = false;
			update_status("Listening for notes...");
		}
		
		if (!recording)
			return;

		buffer = buffer.concat(Array.prototype.slice.call(event.inputBuffer.getChannelData(0)));

		// Stop recording after sample_length_milliseconds.
		if (buffer.length > sample_length_milliseconds * audio_context.sampleRate / 1000)
		{
			recording = false;

			correlation_worker.postMessage
			(
				{
					"timeseries": buffer,
					"test_frequencies": test_frequencies,
					"sample_rate": audio_context.sampleRate
				}
			);

			buffer = [];
			setTimeout(function() { recording = true; }, 250);
		}
	};

	script_processor.onaudioprocess = window.capture_audio;
}

function interpret_correlation_result(event)
{
	var timeseries = event.data.timeseries;
	var frequency_amplitudes = event.data.frequency_amplitudes;

	// Compute the (squared) magnitudes of the complex amplitudes for each
	// test frequency.
	var magnitudes = frequency_amplitudes.map(function(z) { return z[0] * z[0] + z[1] * z[1]; });

	// Find the maximum in the list of magnitudes.
	var maximum_index = -1;
	var maximum_magnitude = 0;
	for (var i = 0; i < magnitudes.length; i++)
	{
		if (magnitudes[i] <= maximum_magnitude)
			continue;

		maximum_index = i;
		maximum_magnitude = magnitudes[i];
	}

	// Compute the average magnitude. We'll only pay attention to frequencies
	// with magnitudes significantly above average.
	var average = magnitudes.reduce(function(a, b) { return a + b; }, 0) / magnitudes.length;
	var confidence = maximum_magnitude / average;
	var confidence_threshold = 10; // empirical, arbitrary.
	if (confidence > confidence_threshold)
	{
		var dominant_frequency = test_frequencies[maximum_index];
		var note_name = dominant_frequency.name;
		var frequency = dominant_frequency.frequency.toFixed(2);
		
		document.getElementById("note-name").textContent = note_name;
		document.getElementById("frequency").textContent = frequency;
		
		// Announce to screen reader only when note changes
		if (note_name !== last_announced_note || Math.abs(frequency - last_announced_frequency) > 0.5) {
			var announcement = "Detected " + note_name + " at " + frequency + " Hertz";
			announce_to_screen_reader(announcement, "polite");
			last_announced_note = note_name;
			last_announced_frequency = parseFloat(frequency);
		}
		
		// Update confidence indicator
		var confidence_percent = Math.min(100, Math.round((confidence - 10) / 90 * 100));
		document.getElementById("confidence").textContent = "Confidence: " + confidence_percent + "%";
		
		// Check if note is perfectly in tune and vibrate for success
		var is_perfect_tune = dominant_frequency.name.indexOf('sharp') === -1 && 
		                      dominant_frequency.name.indexOf('flat') === -1 &&
		                      confidence_percent > 70;
		
		if (is_perfect_tune && note_name !== last_announced_note) {
			vibrate_for_success();
		}
	}
}

// Reference note audio context - initialized on first user interaction
var note_context = null;
var note_node = null;
var gain_node = null;

var playing = false;
var last_announced_note = "";
var last_announced_frequency = 0;
var use_text_to_speech = false;
var speech_synthesis = window.speechSynthesis;
var last_spoken_text = "";
var last_speak_time = 0;
var is_speaking = false;
var detection_paused_for_speech = false;

function toggle_playing_note()
{
	// Initialize audio context on first user interaction
	if (!note_context) {
		try {
			note_context = new (window.AudioContext || window.webkitAudioContext)();
			note_node = note_context.createOscillator();
			gain_node = note_context.createGain();
			note_node.frequency.value = C2 * Math.pow(2, 4 / 12); // E, ~82.41 Hz.
			note_node.connect(gain_node);
			gain_node.connect(note_context.destination);
			note_node.start();
		} catch (error) {
			console.error("Error initializing reference note:", error);
			announce_to_screen_reader("Error: Could not initialize reference note", "assertive");
			return;
		}
	}
	
	// Resume audio context if suspended (required by some browsers)
	if (note_context.state === 'suspended') {
		note_context.resume().catch(function(error) {
			console.error("Error resuming audio context:", error);
			announce_to_screen_reader("Error: Could not play reference note", "assertive");
		});
	}
	
	playing = !playing;
	if (playing) {
		gain_node.gain.setValueAtTime(0, note_context.currentTime);
		gain_node.gain.linearRampToValueAtTime(0.1, note_context.currentTime + 0.01);
		announce_to_screen_reader("Playing E reference note", "status");
		document.getElementById("play-note").textContent = "Stop E reference note";
		document.getElementById("play-note").setAttribute("aria-pressed", "true");
	} else {
		gain_node.gain.linearRampToValueAtTime(0, note_context.currentTime + 0.01);
		announce_to_screen_reader("Stopped E reference note", "status");
		document.getElementById("play-note").textContent = "Play E reference note";
		document.getElementById("play-note").setAttribute("aria-pressed", "false");
	}
}

function announce_to_screen_reader(message, priority) {
	// Screen reader announcement
	var announcer = document.createElement("div");
	announcer.setAttribute("role", "status");
	announcer.setAttribute("aria-live", priority);
	announcer.setAttribute("aria-atomic", "true");
	announcer.className = "sr-only";
	announcer.textContent = message;
	document.body.appendChild(announcer);
	setTimeout(function() {
		if (document.body.contains(announcer)) {
			document.body.removeChild(announcer);
		}
	}, 1000);
	
	// Text-to-speech announcement (if enabled)
	if (use_text_to_speech && speech_synthesis) {
		speak_text(message);
	}
}

function speak_text(text) {
	// Prevent too frequent repetitions
	var now = Date.now();
	if (text === last_spoken_text && now - last_speak_time < 2000) {
		return; // Don't repeat same text within 2 seconds
	}
	
	// Cancel any ongoing speech
	speech_synthesis.cancel();
	
	var utterance = new SpeechSynthesisUtterance(text);
	utterance.rate = 1.0;
	utterance.pitch = 1.0;
	utterance.volume = 0.8;
	
	// Try to get a good voice
	var voices = speech_synthesis.getVoices();
	if (voices.length > 0) {
		// Prefer English voices
		var english_voice = voices.find(function(voice) {
			return voice.lang.startsWith('en');
		});
		if (english_voice) {
			utterance.voice = english_voice;
		}
	}
	
	utterance.onstart = function() {
		is_speaking = true;
		last_spoken_text = text;
		last_speak_time = now;
	};
	
	utterance.onend = function() {
		is_speaking = false;
		detection_paused_for_speech = false;
	};
	
	utterance.onerror = function() {
		is_speaking = false;
		detection_paused_for_speech = false;
	};
	
	speech_synthesis.speak(utterance);
}

function vibrate_for_success() {
	if ("vibrate" in navigator) {
		// Vibrate pattern: short burst, pause, short burst (success confirmation)
		navigator.vibrate([100, 50, 100]);
	}
}

function toggle_text_to_speech() {
	use_text_to_speech = !use_text_to_speech;
	var toggle_button = document.getElementById("toggle-tts");
	
	if (use_text_to_speech) {
		if (speech_synthesis) {
			// Load voices
			speech_synthesis.getVoices();
			toggle_button.textContent = "Disable Voice Announcements";
			toggle_button.setAttribute("aria-pressed", "true");
			announce_to_screen_reader("Voice announcements enabled", "polite");
		} else {
			alert("Text-to-speech is not supported in your browser");
			use_text_to_speech = false;
		}
	} else {
		toggle_button.textContent = "Enable Voice Announcements";
		toggle_button.setAttribute("aria-pressed", "false");
		speech_synthesis.cancel();
		announce_to_screen_reader("Voice announcements disabled", "polite");
	}
}
</script>
</head>

<body>
<main class="container">
    <header>
        <h1>Accessible Guitar Tuner</h1>
    </header>
    
    <div class="instructions" role="region" aria-labelledby="instructions-heading">
        <h2 id="instructions-heading">How to Use</h2>
        <ol class="breadcrumbs-list">
            <li><strong>Allow microphone access</strong> when prompted</li>
            <li><strong>Play a note</strong> on your guitar or other instrument</li>
            <li><strong>Listen</strong> for the note name and frequency announcement</li>
            <li><strong>Feel the vibration</strong> when your note is perfectly in tune (on supported devices)</li>
            <li><strong>Use the reference tone button</strong> to hear an E note for comparison (optional)</li>
            <li><strong>Enable voice announcements</strong> if you don't have a screen reader (optional)</li>
        </ol>
        <p><strong>For screen reader users:</strong> This tuner will automatically announce detected notes. Make sure your screen reader is running and note announcements are enabled.</p>
        <p><strong>For users without screen readers:</strong> Click "Enable Voice Announcements" to hear note names spoken aloud using text-to-speech.</p>
        <p><strong>Vibration feedback:</strong> When you play a note that's perfectly in tune, your device will vibrate (if supported). Voice announcements automatically pause while speaking to avoid interference.</p>
    </div>
    
    <div id="status-message" class="status-message" role="status" aria-live="polite" aria-atomic="true" style="display: none;"></div>
    
    <section class="tuner-display" role="region" aria-labelledby="tuner-heading">
        <div class="grid">
        <h2 id="tuner-heading" class="sr-only">Tuner Display</h2>
            <div>
                <p><strong>It sounds like you're playing...</strong></p>
                <h1 id="note-name" aria-live="polite" aria-atomic="true" tabindex="0"></h1>
            </div>
            <div>
                <p class="frequency-display">
                    <span id="confidence" aria-live="polite"></span>
                    <span>Frequency:</span>
                    <span id="frequency" aria-live="polite" aria-atomic="true"></span>
                    <span> Hertz</span>
                </p>
            </div>
        </div>
    </section>
    
    <section role="region" aria-labelledby="controls-heading">
        <h2 id="controls-heading" class="sr-only">Controls</h2>
        <div class="grid">
            <button id="play-note" class="button" role="switch" aria-pressed="false" aria-describedby="play-note-description">
                Play E reference note
            </button>
            <button id="toggle-tts" class="button" role="switch" aria-pressed="false" aria-describedby="tts-description">
                Enable Voice Announcements
            </button>
        </div>
        <p id="play-note-description" class="sr-only">Click to start or stop a reference E note at 82.41 Hertz</p>
        <p id="tts-description" class="sr-only">Toggle voice announcements for detected notes and status updates (alternative to screen reader)</p>
    </section>
    
    <nav role="navigation" aria-labelledby="links-heading">
        <h2 id="links-heading" class="sr-only">Related Links</h2>
        <a href="https://github.com/barakplasma/Accessible-guitar-tuner">Source code</a> / 
        <a href="http://jonathan.bergknoff.com/journal/making-a-guitar-tuner-html5">Explanatory article</a>
        <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--pico-muted);">
            Version: <code id="git-tag">latest</code> | 
            <a href="https://github.com/barakplasma/Accessible-guitar-tuner/commits/" style="font-size: 0.9rem;">View commits</a>
        </p>
    </nav>
</main>

<style>
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
}
</style>
</body>
</html>
